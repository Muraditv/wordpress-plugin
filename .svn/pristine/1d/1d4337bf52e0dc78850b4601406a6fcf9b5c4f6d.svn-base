jQuery( document ).ready(function( $ ) {
    tinymce.create('tinymce.plugins.S3bubbleOembed', {
        init : function(ed, url) {

            /*
             * S3bubble video
             */
            ed.addButton('s3bubble_oembed_global_shortcode', {
                title : 'S3Bubble',
                cmd : 's3bubble_oembed_global_shortcode',
                image : url + '/s3bubbletiny_video_single.png'
            });
            ed.addCommand('s3bubble_oembed_global_shortcode', function() {

                $.post("https://s3api.com/oembed/codes/", {
                    website: s3bubble_oembed_uid.s3website
                }, function(response) {

                    if(response.error){

                        // run a alert
                        swal({
                          title: "Error! " + response.message,
                          text: "Loading...",
                          type: "error",
                          showCancelButton: false,
                          showConfirmButton: true,
                          confirmButtonClass: "button button-danger",
                          confirmButtonText: "Ok",
                          closeOnConfirm: true
                        },
                        function(isConfirm) {
                          $('.s3bubble-select-group').html();
                        });
                        //$('.s3bubble-select-group').html('<div style="position: relative;padding-bottom: 56.25%;"><iframe style="position: absolute;top: 0;left: 0;width: 100%;height: 100%;" src="https://www.youtube.com/embed/jUY7UT4KDjA" frameborder="0" allowfullscreen></iframe></div>');
                         
                    }else{

                        swal({
                          title: "Please select your media below",
                          text: "Loading...",
                          type: "info",
                          showCancelButton: true,
                          showConfirmButton: true,
                          confirmButtonClass: "button button-primary",
                          confirmButtonText: "Select",
                          cancelButtonText: "Cancel",
                          closeOnConfirm: true,
                          closeOnCancel: true
                        },
                        function(isConfirm) {
                            if (isConfirm) {

                                var edUrl = $('#s3bubbleIframeUrl').find('option:selected').attr('id');
                                var url = $('#s3bubbleIframeUrl').find('option:selected').val();
                                tinyMCE.activeEditor.execCommand('mceInsertContent', 0, url);

                                setTimeout(function () {
                                    swal({
                                      title: "You can edit your media in S3Bubble!",
                                      text: "Would you like us to open it up in a new tab? Please make sure you are logged in.",
                                      type: "info",
                                      showCancelButton: true,
                                      confirmButtonClass: "button button-primary",
                                      confirmButtonText: "Yes",
                                      cancelButtonText: "No",
                                      closeOnConfirm: true,
                                      closeOnCancel: true
                                    },
                                    function(isNewConfirm) {
                                        if (isNewConfirm) {
                                            var editWin = window.open(edUrl, '_blank');
                                            editWin.focus();
                                        } 
                                    });
                                }, 1000);
                                
                            } 
                        });

                        var html = '<select class="chosen-select" tabindex="1" name="s3bubbleIframeUrl" id="s3bubbleIframeUrl"><option value="">Select Media</option>';
                        $.each(response.results, function (i, item) {

                            var code = item.code;
                            var bucket = item.bucket;
                            var key = item.key;
                            var title = item.title;
                            var ext = item.ext;
                            var type = item.type;
                            if(ext === "mp4"){
                                html += '<option id="https://s3bubble.com/secure/#/single_video/' + bucket + '/' + key.replace(/\//g, "+") + '" value="https://media.s3bubble.com/embed/progressive/id/' + code + '">' + key + '</option>'; 
                            }
                            if(ext === "mp3" || ext === "m4a"){
                                html += '<option id="https://s3bubble.com/secure/#/single_audio/' + bucket + '/' + key.replace(/\//g, "+") + '"  value="https://media.s3bubble.com/embed/aprogressive/id/' + code + '">' + key + '</option>';   
                            }
                            if(ext === "m3u8"){
                                html += '<option id="https://s3bubble.com/secure/#/single_hls/' + bucket + '/' + key.replace(/\//g, "+") + '"  value="https://media.s3bubble.com/embed/hls/id/' + code + '">' + key + '</option>';  
                            }
                            if(type === "audio"){
                                html += '<option id="https://s3bubble.com/secure/#/audio_playlist/' + code + '"  value="https://media.s3bubble.com/embed/aplaylist/id/' + code + '">Audio Playlist: ' + title + '</option>';    
                            }
                            if(type === "video"){
                                html += '<option id="https://s3bubble.com/secure/#/video_playlist/' + code + '"  value="https://media.s3bubble.com/embed/playlist/id/' + code + '">Video Playlist: ' + title + '</option>'; 
                            }
                            
                        });
                        html += '</select>';
                        $('.s3bubble-select-group').html(html);
                        var config = {
                          '.chosen-select'           : {},
                          '.chosen-select-deselect'  : {allow_single_deselect:true},
                          '.chosen-select-no-single' : {disable_search_threshold:10},
                          '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
                          '.chosen-select-width'     : {width:"95%"}
                        }
                        for (var selector in config) {
                          $(selector).chosen(config[selector]);
                        }

                    }   

                },'json');

            });
            
        },
    });
    // Register plugin
    tinymce.PluginManager.add( 'S3bubbleOembed', tinymce.plugins.S3bubbleOembed );
});